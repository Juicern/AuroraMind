sequenceDiagram
    autonumber
    participant FE as Frontend
    participant GO as Go App Service
    participant PG as PostgreSQL
    participant PY as Python AI Service
    participant FS as Local/S3 Storage
    participant OA as OpenAI API
    participant PC as Pinecone

    FE->>GO: POST /v1/kb/{id}/documents (file upload)
    GO->>FS: Save file locally/S3
    GO->>PG: INSERT document metadata (status=pending)
    GO->>PY: POST /internal/ingest (doc_id, storage_uri)

    PY->>FS: Load file
    PY->>PY: Extract & clean text (fails if no selectable text)
    PY->>PY: Chunk text (text-only PDFs supported)

    loop for each chunk
        PY->>PG: INSERT kb_chunk
        PY->>OA: Create embedding
        OA-->>PY: embedding
        PY->>PC: Upsert vector (namespace=collection)
    end

    PY->>PG: UPDATE document status â†’ ready
    PY-->>GO: {status: "done"}
    GO-->>FE: ingestion updated

    alt User deletes document
        FE->>GO: DELETE /v1/kb/{id}/documents/{doc_id}
        GO->>PG: DELETE document metadata
        GO->>FS: Remove stored file
    end
